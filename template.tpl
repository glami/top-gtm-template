___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "categories": [
    "SURVEY"
  ],
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "GLAMI TOP",
  "brand": {
    "id": "github.com_glami",
    "displayName": "glami",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "GLAMI TOP Opt-in JavaScript code. Using this API your customers can opt-in to participate in GLAMI TOP and express their satisfaction in a review.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "apiKey",
    "displayName": "Partner API key",
    "simpleValueType": true,
    "notSetText": "API is mandatory.",
    "help": "Your API key provided by Glami",
    "valueValidators": [
      {
        "type": "STRING_LENGTH",
        "args": [
          32,
          32
        ]
      }
    ],
    "valueHint": "Your API key provided by Glami"
  },
  {
    "type": "TEXT",
    "name": "countryCode",
    "displayName": "Country code",
    "simpleValueType": true,
    "help": "Glami domain identifier - ISO 3166-1 alpha-2 code",
    "valueHint": "Glami domain identifier - ISO 3166-1 alpha-2 code"
  },
  {
    "type": "TEXT",
    "name": "orderId",
    "displayName": "Order ID",
    "simpleValueType": true,
    "notSetText": "Order ID is mandatory.",
    "help": "Unique order identifier.",
    "valueHint": "Unique order identifier."
  },
  {
    "type": "TEXT",
    "name": "email",
    "displayName": "Customer email",
    "simpleValueType": true,
    "notSetText": "Customer email value is mandatory.",
    "help": "Customer email provided during order process",
    "valueHint": "Customer email provided during order process"
  },
  {
    "type": "TEXT",
    "name": "language",
    "displayName": "Language code",
    "simpleValueType": true,
    "help": "Language code determines which language GLAMI will use to communicate with the customer. Valid formats are ISO 639-1.",
    "valueHint": "Customer language code",
    "notSetText": "Language field is mandatory."
  },
  {
    "type": "TEXT",
    "name": "productNames",
    "displayName": "Product names",
    "simpleValueType": true,
    "help": "Names of bought products. Multiple values are separated by semicolon (;). Preferably use the same names as in your Glami product feed.",
    "notSetText": "Product names field is mandatory.",
    "valueHint": "Names of bought products"
  },
  {
    "type": "TEXT",
    "name": "productIds",
    "displayName": "Product IDs",
    "simpleValueType": true,
    "notSetText": "Product IDs field is mandatory.",
    "help": "IDs of bought products. Multiple values are separated by semicolon (;). Preferably use the same IDs as in your Glami product feed.",
    "valueHint": "IDs of bought products"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const log = require('logToConsole');
const set = require('setInWindow');
const createArgumentsQueue = require('createArgumentsQueue');
const getType = require('getType');

let glamiObject = function () {
  createArgumentsQueue('glami_or', 'glamiObject.q');
};

set('GlamiOrderReview', 'glami_or');
set('glami_or', glamiObject);

// Split a string by a string
const explode = function (delimiter, string) {
  return string.split(delimiter).map(function(el) { return el.trim(); }).filter(function(el) { return el; });
};

// creates items object from ids and names strings
const getItems = function (productIds, productNames) {
  let items = [];
  let ids = getType(productIds) === 'array' ? productIds : explode(';', productIds);
  let names = getType(productNames) === 'array' ? productNames : explode(';', productNames);
  
  ids.forEach(function (value, index) {
    // check if relevant product name exists
  	if (typeof names[index] !== 'undefined') {
    	items.push({'id': value, 'name': names[index]});
    }
  });
  
  return items;
};

const onSuccess = function () {
  callInWindow('glami_or', 'addParameter', 'merchant_id', data.apiKey, data.countryCode);
  callInWindow('glami_or', 'addParameter', 'order_id', data.orderId);
  callInWindow('glami_or', 'addParameter', 'email', data.email);
  callInWindow('glami_or', 'addParameter', 'language', data.language);
  callInWindow('glami_or', 'addParameter', 'items', getItems(data.productIds, data.productNames));
  callInWindow('glami_or', 'create');
  
  data.gtmOnSuccess();
};

const onFailure = function () {
  log('Error loading GLAMI TOP js api.');
  
  data.gtmOnFailure();
};

injectScript('https://www.glami.cz/js/compiled/or.js', onSuccess, onFailure);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "GlamiOrderReview"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "glami_or"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "glami_or.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.glami.cz/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 22/11/2019, 09:05:22
